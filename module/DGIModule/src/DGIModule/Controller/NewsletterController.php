<?php/** * @link      https://github.com/demodyne/demodyne * @copyright Copyright (c) 2015-2017 Demodyne (https://www.demodyne.org) * @license   http://www.gnu.org/licenses/agpl.html GNU Affero General Public License */namespace DGIModule\Controller;use Zend\Filter\File\Rename;use Zend\Mvc\Controller\AbstractActionController;use Zend\View\Model\JsonModel;use Zend\View\Model\ViewModel;use Zend\Session\Container;use Doctrine\Common\Collections\ArrayCollection;use DGIModule\Entity\Newsletter;use DGIModule\Form\AddEditNewsletterForm;use DGIModule\Entity\Inbox;use Ramsey\Uuid\Uuid;use Doctrine\ORM\EntityManager;use Zend\Mvc\I18n\Translator;class NewsletterController extends AbstractActionController{    protected $entityManager;    protected $translator;    protected $config;    public function __construct(        array $config,        EntityManager $entityManager,        Translator $translator    )    {        $this->config = $config;        $this->entityManager = $entityManager;        $this->translator = $translator;    }        public function addNewsletterAction() {        $user = $this->identity();        $publish = $this->params()->fromRoute('publish', false);        $newsletter = new Newsletter();        $form = new AddEditNewsletterForm($this->translator);        $form->setAttribute('action', $this->url()->fromRoute('administration/newsletter', array('action'=>'add-newsletter')));        /** @var $request \Zend\Http\Request */        $request = $this->getRequest();        if ($request->isPost()) {            $post = array_merge_recursive(                $request->getPost()->toArray(),                $request->getFiles()->toArray()                );            $form->bind($newsletter);            $form->setData($post);            //verify if picture change            $picture = $post["picture-file"]["name"];            if ($form->isValid()) {                if ($picture!="") {                    $files   = $request->getFiles();                    $target = getcwd() . "/public/img/newsletters/nl.jpg";                    $filterR = new Rename(array(                        "target"    => $target,                        "randomize" => true,                    ));                    $filename= $filterR->filter($files['picture-file']);                    chmod($filename["tmp_name"], 0644);                    $newsletter->setNlHeaderImage(str_replace(getcwd() . "/public", '', $filename["tmp_name"]));                }                $categories = $this->params()->fromPost('categories', []);                foreach ($categories as $categoryId) {                    $category = $this->entityManager->getRepository('DGIModule\Entity\Category')->findOneBy(['catId'=>$categoryId]);                    $newsletter->addCategory($category);                }                $newsletter->setAdmin($user->getAdmin())                           ->setCity($user->getAdmin()->getAdminCity())                           ->setNlCreatedDate(new \DateTime())                           ->setNlUUID(Uuid::uuid4())                ;                $this->entityManager->persist($newsletter);                $this->entityManager->flush();                $this->entityManager->refresh($newsletter);                if ($publish) {                    $this->publishNewsletter($newsletter);                }                return new JsonModel(array('success' => true));            }        }        $mainCategories = $this->entityManager->getRepository('DGIModule\Entity\Category')->getMainCategories($user);        $viewModel = new ViewModel();        //disable layout if request by Ajax        $viewModel->setTerminal($request->isXmlHttpRequest());        $viewModel->setVariables([            'form'=>$form,            'user' => $user,            'mainCategories' => $mainCategories,        ]);	    return $viewModel;	}	public function editNewsletterAction() {	    $user = $this->identity();	    $publish = $this->params()->fromRoute('publish', false);	    $newsletterUUID = $this->params('id');	    // no parameter	    if (!$newsletterUUID) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        /** @var \DGIModule\Entity\Newsletter $newsletter */        $newsletter = $this->entityManager->getRepository('DGIModule\Entity\Newsletter')->findOneBy(array('nlUUID' => $newsletterUUID));        if (!$newsletter || !$user->isAdministration() || $newsletter->getAdmin()!=$user->getAdmin()) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        $form = new AddEditNewsletterForm($this->translator, $newsletter);	    $form->setAttribute('action', $this->url()->fromRoute('administration/newsletter', array('action'=>'edit-newsletter', 'id' => $newsletterUUID)));	    $oldFilename = $newsletter->getNlHeaderImage();	    $request = $this->getRequest();	    if ($request->isPost()) {	        $post = array_merge_recursive(	            $request->getPost()->toArray(),	            $request->getFiles()->toArray()	            );	        $form->bind($newsletter);	        $form->setData($post);	        $picture = $post["picture-file"]["name"];	        // TODO verify file size	        if ($form->isValid()) {	            if ($picture!="") {	                $files   = $request->getFiles();	                $target = getcwd() . "/public/img/newsletters/nl.jpg";	                $filterR = new Rename(array(	                    "target"    => $target,	                    "randomize" => true,	                ));	                $filename= $filterR->filter($files['picture-file']);	                chmod($filename["tmp_name"], 0644);	                $newsletter->setNlHeaderImage(str_replace(getcwd() . "/public", '', $filename["tmp_name"]));	                if ($oldFilename && file_exists(getcwd() . '/public'.$oldFilename)) {	                    unlink(getcwd() . '/public'.$oldFilename);	                }	            }                $categories = $this->params()->fromPost('categories', []);                $newsletter->resetCategories();                foreach ($categories as $categoryId) {                    /** @var \DGIModule\Entity\Category $category */                    $category = $this->entityManager->getRepository('DGIModule\Entity\Category')->findOneBy(['catId'=>$categoryId]);                    $newsletter->addCategory($category);                }                $this->entityManager->merge($newsletter);                $this->entityManager->flush();                $this->entityManager->refresh($newsletter);                if ($publish) {                    $this->publishNewsletter($newsletter);                }                return new JsonModel(array('success' => true));            }        }        $mainCategories = $this->entityManager->getRepository('DGIModule\Entity\Category')->getMainCategories($user);        $viewModel = new ViewModel();        //disable layout if request by Ajax        $viewModel->setTerminal($request->isXmlHttpRequest());        $viewModel->setTemplate('dgi-module/newsletter/add-newsletter.phtml');        $viewModel->setVariables([            'form'=>$form,            'newsletter' => $newsletter,            'user' => $user,            'mainCategories' => $mainCategories,        ]);        return $viewModel;    }    public function duplicateNewsletterAction() {	    $user = $this->identity();	    $newsletterUUID = $this->params('id');	    // no parameter	    if (!$newsletterUUID) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        $newsletter = $this->entityManager->getRepository('DGIModule\Entity\Newsletter')->findOneBy(array('nlUUID' => $newsletterUUID));        if (!$newsletter || !$user->isAdministration() || $newsletter->getAdmin()!=$user->getAdmin()) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        $form = new AddEditNewsletterForm($this->translator, $newsletter);	    $form->setAttribute('action', $this->url()->fromRoute('administration/newsletter', array('action'=>'add-newsletter', 'id' => $newsletterUUID)));        $mainCategories = $this->entityManager->getRepository('DGIModule\Entity\Category')->getMainCategories($user);        $viewModel = new ViewModel();        //disable layout if request by Ajax        $viewModel->setTerminal($this->getRequest()->isXmlHttpRequest());        $viewModel->setTemplate('dgi-module/newsletter/add-newsletter.phtml');        $viewModel->setVariables([            'form'=>$form,            'newsletter' => $newsletter,            'user' => $user,            'mainCategories' => $mainCategories,        ]);        return $viewModel;    }    /**     * @todo if newsletter sent then return false     *     * @return mixed|JsonModel|ViewModel     */    public function deleteNewsletterAction()    {        $user = $this->identity();        $nlUUID = $this->params('id', '0');        if (!$nlUUID) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        /** @var \DGIModule\Entity\Newsletter $newsletter */        $newsletter = $this->entityManager->getRepository('DGIModule\Entity\Newsletter')->findOneBy(array('nlUUID' => $nlUUID, 'nlSentDate' => null));        if (!$newsletter || $newsletter->getAdmin()!=$user->getAdmin()) {            return $this->forward()->dispatch('DGIModule\Controller\Error', array('action' => 'access-denied'));        }        /** @var $request \Zend\Http\Request */        $request = $this->getRequest();        if ($request->isPost()){            $newsletter->setNlIsSent(1);            $this->entityManager->remove($newsletter);            $this->entityManager->flush();            return new JsonModel(array('success' => true));        }        $viewModel = new ViewModel();        $viewModel->setTerminal($request->isXmlHttpRequest());        $viewModel->setVariables([            'newsletter' => $newsletter,        ]);        return $viewModel;    }    private function publishNewsletter(Newsletter $newsletter) {        $user = $this->identity();        $nlSendTo = $newsletter->getNlSendTo();        $toUsers = new  ArrayCollection();        // send to contacts        if (($$nlSendTo>>3)&1) {            foreach ($user->getContacts() as $usr) $toUsers->add($usr);        }        // send to all citizen        if (($$nlSendTo>>2)&1) {            $citizens = $this->entityManager->getRepository('DGIModule\Entity\User')->findCitizens($user->getAdmin(), $this->config['demodyne']['level']);            foreach ($citizens as $usr) {                if (!$toUsers->contains($usr)) {                    $toUsers->add($usr);                }            }        }        // send to partners        if (($$nlSendTo>>0)&1) {            $partners = $this->entityManager->getRepository('DGIModule\Entity\User')->findNewsletterPartners($newsletter);            foreach ($partners as $usr) {                if (!$toUsers->contains($usr)) {                    $toUsers->add($usr);                }            }        }        $group = uniqid('', true);        foreach ($toUsers as $toUsr) {            $message = new Inbox();            $message->setToUsr($toUsr)                    ->setFromUsr($user)                    ->setIbxTitle($newsletter->getNlSubject())                    ->setIbxText($newsletter->getNlMessage())                    ->setIbxType($this->config['demodyne']['inbox']['type']['newsletter'])                    ->setIbxGroup($group)                    ->setNewsletter($newsletter);            $this->entityManager->persist($message);            // send private message to user            $this->forward()->dispatch('DGIModule\Controller\Email', array(                'action' => 'new-newsletter',                'id' => $message->getIbxUUID(),                'email' => 'true'            ));            // TODO: add receiver to contacts if not        }        $newsletter->setNlSentDate(new \DateTime());        $this->entityManager->merge($newsletter);        $this->entityManager->flush();    }	public function myNewslettersAction() {	    $user = $this->identity();	    $session = new Container('newsletter');	    $page = $this->params()->fromRoute('page', null);	    if (!$page) {	        if (!$session->myNewslettersPage) {	            $page = 1;	        }	        else {	            $page = $session->myNewslettersPage;	        }	    }	    $session->myNewslettersPage = $page;	    $sort = $this->params()->fromRoute('sort', null);	    if (!$sort) {	        if (!$session->myNewslettersSort) {	            $sort = 'created_date';	        }	        else {	            $sort = $session->myNewslettersSort;	        }	    }	    $session->myNewslettersSort = $sort;	    $order = $this->params()->fromRoute('order', null);	    if (!$order) {	        if (!$session->myNewslettersOrder) {	            $order = 'desc';	        }	        else {	            $order = $session->myNewslettersOrder;	        }	    }	    $session->myNewslettersOrder = $order;	    $limit= $this->params()->fromRoute('results', null);	    if (!$limit) {	        if (!$session->myNewslettersResults) {	            $limit = 10;	        }	        else {	            $limit = $session->myNewslettersResults;	        }	    }	    $session->myNewslettersResults = $limit;	    $newslettersCount = $this->entityManager->getRepository('DGIModule\Entity\Newsletter')->countAdminNewsletters($user->getAdmin());	    $newslettersCount = $newslettersCount["total"];	    $offset = ($page == 0) ? 0 : ($page - 1) * $limit;	    $pagedNewsletters = $this->entityManager->getRepository('DGIModule\Entity\Newsletter')->getAdminPagedNewsletters($user->getAdmin(), $offset, $limit, $sort, $order);	    $viewModel = new ViewModel();	    $viewModel->setTerminal($this->getRequest()->isXmlHttpRequest());	    $viewModel->setVariables([	        'pagedNewsletters' => $pagedNewsletters,	        'limit' => $limit,	        'page' => $page,	        'sort' => $sort,	        'order' => $order,	        'user' => $user,	        'newslettersCount' => $newslettersCount	    ]);	    return $viewModel;	}}